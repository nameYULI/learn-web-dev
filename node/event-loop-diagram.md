# Node.js äº‹ä»¶å¾ªçŽ¯å®Œæ•´å›¾è§£

## ðŸ“ æ‰§è¡Œèµ·ç‚¹å®šä½å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ðŸš€ ä»£ç æ‰§è¡Œå…¥å£                            â”‚
â”‚                                                              â”‚
â”‚  1ï¸âƒ£ åŒæ­¥ä»£ç æ‰§è¡Œï¼ˆScript Mainï¼‰                                â”‚
â”‚     â†“                                                        â”‚
â”‚  2ï¸âƒ£ æ³¨å†Œå¼‚æ­¥ä»»åŠ¡åˆ°å¯¹åº”é˜Ÿåˆ—                                      â”‚
â”‚     â€¢ setTimeout/setInterval â†’ Timer é˜Ÿåˆ—                    â”‚
â”‚     â€¢ setImmediate â†’ Check é˜Ÿåˆ—                             â”‚
â”‚     â€¢ I/O æ“ä½œ â†’ Poll é˜Ÿåˆ—                                   â”‚
â”‚     â€¢ process.nextTick â†’ nextTick é˜Ÿåˆ—                      â”‚
â”‚     â€¢ Promise.then â†’ å¾®ä»»åŠ¡é˜Ÿåˆ—                              â”‚
â”‚     â†“                                                        â”‚
â”‚  3ï¸âƒ£ åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œè¿›å…¥äº‹ä»¶å¾ªçŽ¯                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ”„ äº‹ä»¶å¾ªçŽ¯å®Œæ•´æµç¨‹å›¾

```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚           timers          â”‚<â”€â”€â”€â”€â”€â”€ setTimeout
â”‚  â”‚  (æ‰§è¡Œå®šæ—¶å™¨å›žè°ƒ)          â”‚        setInterval
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                â”‚
â”‚                â†“ ã€æ¸…ç©ºå¾®ä»»åŠ¡ã€‘
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks     â”‚<â”€â”€â”€â”€â”€â”€ I/O é”™è¯¯å›žè°ƒ
â”‚  â”‚  (æ‰§è¡Œå»¶è¿Ÿçš„I/Oå›žè°ƒ)       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                â”‚
â”‚                â†“ ã€æ¸…ç©ºå¾®ä»»åŠ¡ã€‘
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚       idle, prepare       â”‚<â”€â”€â”€â”€â”€â”€ å†…éƒ¨ä½¿ç”¨
â”‚  â”‚     (ä»…å†…éƒ¨ä½¿ç”¨)          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                â”‚
â”‚                â†“ ã€æ¸…ç©ºå¾®ä»»åŠ¡ã€‘
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚           poll            â”‚<â”€â”€â”€â”€â”€â”€ I/O äº‹ä»¶
â”‚  â”‚   (èŽ·å–æ–°çš„I/Oäº‹ä»¶)        â”‚        æ–‡ä»¶è¯»å†™
â”‚  â”‚                           â”‚        ç½‘ç»œè¯·æ±‚
â”‚  â”‚  â— è®¡ç®—é˜»å¡žæ—¶é—´           â”‚
â”‚  â”‚  â— å¤„ç†pollé˜Ÿåˆ—äº‹ä»¶        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                â”‚
â”‚                â†“ ã€æ¸…ç©ºå¾®ä»»åŠ¡ã€‘
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚           check           â”‚<â”€â”€â”€â”€â”€â”€ setImmediate
â”‚  â”‚  (æ‰§è¡ŒsetImmediateå›žè°ƒ)   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                â”‚
â”‚                â†“ ã€æ¸…ç©ºå¾®ä»»åŠ¡ã€‘
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚      close callbacks      â”‚<â”€â”€â”€â”€â”€â”€ socket.close
â””â”€â”€â”¤   (æ‰§è¡Œcloseäº‹ä»¶å›žè°ƒ)      â”‚        ç­‰å…³é—­äº‹ä»¶
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš¡ å¾®ä»»åŠ¡æ‰§è¡Œæ—¶æœºå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ¯ä¸ªé˜¶æ®µç»“æŸåŽçš„å¾®ä»»åŠ¡å¤„ç†                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  é˜¶æ®µç»“æŸ â†’ å¾®ä»»åŠ¡å¤„ç†é¡ºåºï¼š                           â”‚
â”‚                                                      â”‚
â”‚  1. process.nextTick é˜Ÿåˆ—ï¼ˆé€’å½’æ¸…ç©ºï¼‰                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚     â”‚ nextTick1 â†’ nextTick2 â†’ â”‚ å…¨éƒ¨æ‰§è¡Œå®Œ           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                â†“                                     â”‚
â”‚  2. Promise å¾®ä»»åŠ¡é˜Ÿåˆ—                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚     â”‚ Promise1 â†’ Promise2 â†’   â”‚ å…¨éƒ¨æ‰§è¡Œå®Œ           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                â†“                                     â”‚
â”‚  3. è¿›å…¥ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªçŽ¯é˜¶æ®µ                             â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ“Š å®šæ—¶å™¨æ‰§è¡Œæ—¶æœºå¯¹æ¯”

```
åœºæ™¯1ï¼šåœ¨è„šæœ¬å¼€å§‹æ—¶æ³¨å†Œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setTimeout(() => {}, 0)  â”€â”€â”
setTimeout(() => {}, 0)  â”€â”€â”¼â”€â”€> åŒä¸€ä¸ª timer é˜¶æ®µæ‰§è¡Œ
setTimeout(() => {}, 5)  â”€â”€â”˜

åœºæ™¯2ï¼šåœ¨ timer å›žè°ƒä¸­æ³¨å†Œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setTimeout(() => {
  console.log('timer1');
  setTimeout(() => {      â”€â”€â”€â”€> ä¸‹ä¸€è½®å¾ªçŽ¯çš„ timer é˜¶æ®µ
    console.log('timer2');
  }, 0);
}, 0);

åœºæ™¯3ï¼šsetTimeout vs setImmediate
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        å½“å‰å¾ªçŽ¯            ä¸‹ä¸€è½®å¾ªçŽ¯
Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Timer
  â†“                       â†‘
Check (setImmediate)      â”‚
  â†“                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸŽ¯ ä»£ç æ‰§è¡Œå®šä½å¿«é€ŸæŸ¥è¯¢è¡¨

| ä»£ç ç±»åž‹ | æ‰§è¡Œæ—¶æœº | æ‰§è¡Œé˜¶æ®µ | ä¼˜å…ˆçº§ |
|---------|---------|---------|--------|
| åŒæ­¥ä»£ç  | ç«‹å³æ‰§è¡Œ | Main Script | æœ€é«˜ |
| process.nextTick | å½“å‰é˜¶æ®µç»“æŸåŽ | å¾®ä»»åŠ¡ | é«˜ |
| Promise.then | nextTick ä¹‹åŽ | å¾®ä»»åŠ¡ | ä¸­é«˜ |
| setTimeout(0) | ä¸‹ä¸€ä¸ª timer é˜¶æ®µ | Timer | ä¸­ |
| setImmediate | å½“å‰/ä¸‹ä¸€ä¸ª check é˜¶æ®µ | Check | ä¸­ä½Ž |
| I/O å›žè°ƒ | Poll é˜¶æ®µ | Poll | ä½Ž |

## ðŸ’¡ å…³é”®ç†è§£ç‚¹

1. **ä»£ç ä»Žå“ªå¼€å§‹ï¼Ÿ**
   - æ°¸è¿œä»ŽåŒæ­¥ä»£ç å¼€å§‹
   - åŒæ­¥ä»£ç æ‰§è¡Œæ—¶æ³¨å†Œå„ç§å¼‚æ­¥ä»»åŠ¡

2. **å¦‚ä½•åˆ¤æ–­æ‰§è¡Œé¡ºåºï¼Ÿ**
   - çœ‹æ³¨å†Œæ—¶æœºï¼šä½•æ—¶è¢«åŠ å…¥é˜Ÿåˆ—
   - çœ‹å½“å‰é˜¶æ®µï¼šäº‹ä»¶å¾ªçŽ¯åœ¨å“ªä¸ªé˜¶æ®µ
   - çœ‹é˜Ÿåˆ—ç±»åž‹ï¼šå¾®ä»»åŠ¡ > å®ä»»åŠ¡

3. **ä¸ºä»€ä¹ˆæœ‰æ—¶é¡ºåºä¸åŒï¼Ÿ**
   - Timer é˜¶æ®µçš„å¿«ç…§æœºåˆ¶
   - å¾®ä»»åŠ¡çš„é€’å½’å¤„ç†
   - I/O çš„ä¸ç¡®å®šæ€§

## ðŸ” è°ƒè¯•æŠ€å·§

```javascript
// è¿½è¸ªå½“å‰æ‰§è¡Œä½ç½®
function trace(label) {
  console.log(`[${Date.now()}] ${label}`);
  console.trace(); // æ˜¾ç¤ºè°ƒç”¨æ ˆ
}

// æ ‡è®°ä¸åŒç±»åž‹çš„å¼‚æ­¥æ“ä½œ
setTimeout(() => trace('TIMER'), 0);
setImmediate(() => trace('IMMEDIATE'));
process.nextTick(() => trace('NEXTTICK'));
Promise.resolve().then(() => trace('PROMISE'));
```